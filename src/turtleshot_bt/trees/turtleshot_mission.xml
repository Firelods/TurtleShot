<?xml version="1.0"?>

<root main_tree_to_execute="TurtleShotMission" BTCPP_format="4">

  <!-- ===================== -->
  <!-- ARBRE PRINCIPAL       -->
  <!-- ===================== -->
  <BehaviorTree ID="TurtleShotMission">
    <Sequence name="MissionSequence">

      <!-- 1) Explorer jusqu'à trouver une personne -->
      <SubTree ID="ExploreUntilTargetFound"
               target_type="person"
               target_x="{person_x}"
               target_y="{person_y}"
               target_yaw="{person_yaw}"/>

      <!-- 2) Aller vers la personne -->
      <Action ID="NavigateToPose"
              x="{person_x}"
              y="{person_y}"
              yaw="{person_yaw}"
              name="GoToPerson"/>

      <!-- 3) Explorer jusqu'à trouver la poubelle -->
      <SubTree ID="ExploreUntilTargetFound"
               target_type="trash"
               target_x="{trash_x}"
               target_y="{trash_y}"
               target_yaw="{trash_yaw}"/>

      <!-- 4) Aller vers la poubelle -->
      <Action ID="NavigateToPose"
              x="{trash_x}"
              y="{trash_y}"
              yaw="{trash_yaw}"
              name="GoToTrash"/>

      <!-- 5) Tirer -->
      <Action ID="FireCatapult" name="LaunchProjectile"/>

    </Sequence>
  </BehaviorTree>

  <!-- ============================================== -->
  <!-- SOUS-ARBRE : Explorer jusqu'à détecter la cible -->
  <!-- ============================================== -->
  <BehaviorTree ID="ExploreUntilTargetFound">
    <!--
      Répète indéfiniment :
        - Si HasTarget(target_type) -> SUCCESS (on sort du subtree)
        - Sinon, on patrouille
    -->
    <RetryUntilSuccessful num_attempts="-1">
      <Fallback name="SearchTarget">
        <!-- Condition : la cible est déjà détectée ? -->
        <Condition ID="HasTarget"
                   target_type="{target_type}"
                   target_x="{target_x}"
                   target_y="{target_y}"
                   target_yaw="{target_yaw}"
                   name="CheckTargetDetected"/>

        <!-- Sinon, on patrouille pour cartographier et chercher -->
        <Sequence name="PatrolSequence">
          <Action ID="NavigateToPose" x="2.0"  y="2.0"  yaw="0.0"    name="WP1"/>
          <Action ID="NavigateToPose" x="-2.0" y="2.0"  yaw="1.57"   name="WP2"/>
          <Action ID="NavigateToPose" x="-2.0" y="-2.0" yaw="3.14"   name="WP3"/>
          <Action ID="NavigateToPose" x="2.0"  y="-2.0" yaw="-1.57"  name="WP4"/>
        </Sequence>
      </Fallback>
    </RetryUntilSuccessful>
  </BehaviorTree>

  <!-- ===================== -->
  <!-- DÉCLARATION DES NŒUDS -->
  <!-- ===================== -->
  <TreeNodesModel>
    <Action ID="NavigateToPose">
      <input_port name="x">X position in map frame</input_port>
      <input_port name="y">Y position in map frame</input_port>
      <input_port name="yaw">Orientation in radians</input_port>
    </Action>

    <Action ID="FireCatapult"/>

    <Condition ID="HasTarget">
      <input_port name="target_type">Type of target (person/trash)</input_port>
      <output_port name="target_x">Detected X position</output_port>
      <output_port name="target_y">Detected Y position</output_port>
      <output_port name="target_yaw">Detected orientation</output_port>
    </Condition>

    <Decorator ID="RetryUntilSuccessful">
      <input_port name="num_attempts">Maximum number of attempts (-1 = infinite)</input_port>
    </Decorator>
  </TreeNodesModel>

</root>
